% SPDX-License-Identifier: CC-BY-SA-4.0
% Author: Matthieu Perrin
% Part: 
% Section: 
% Sub-section: 
% Frame: 

\begingroup

\begin{frame}[fragile]{Un compteur non-bloquant}
  \begin{itemize}
  \item Implémentation de \lstinline{AtomicInteger.getAndIncrement}
    dans l'\href{https://github.com/openjdk-mirror/jdk7u-jdk/blob/master/src/share/classes/java/util/concurrent/atomic/AtomicInteger.java}{OpenJDK 7}
  \end{itemize}

  \begin{lstlisting}
    class Counter {
      private (*\Alert{AtomicInteger value}*) = new AtomicInteger( (*\Structure{0}*) ); 
      public int getAndIncrement() {
        for (;;) {
          int current = (*\Alert{value.get();}*)
          int next = (*\Structure{current + 1;}*)
          if ( (*\Alert{value.compareAndSet(current, next)}*) ){
            return (*\Structure{current;}*)
          }
        }
      }
    }
  \end{lstlisting}
  
  \begin{block}{L'opération \alert{atomique} compare\_and\_swap}
    \begin{lstlisting}[gobble=4]
      compareAndSet(T expect, T udpade) {
        if (get() == expect) {
          set(update);
          return true;
        }
        return false;
      }
    \end{lstlisting}
  \end{block}

  \on[x=20mm]{\example{Sûreté ?~~~~Vivacité ?}}

  \on[text, y=-30mm, x=20mm]{
    \begin{description}
    \item [Java :] \lstinline{boolean compareAndSet(T expect, T update)}
    \item [C++ :] \lstinline{bool compare_exchange_strong (T& expected, T val)}
    \end{description}
  }
  
\end{frame}

\endgroup
\endinput
